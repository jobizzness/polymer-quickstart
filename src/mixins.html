<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer-redux/polymer-redux.html">
<link rel="import" href="../../../bower_components/lazy-imports/lazy-imports-mixin.html">

<script>
  
  const AppMediator = () => class extends ReduxMixin(Polymer.LazyImportsMixin(Polymer.Element)) {}
  const AppComponent = () => class extends ReduxMixin(Polymer.Element) {}


</script>


<!-- App router -->
<script>
    const AppRouter = () => class extends AppComponent() {
        static get properties() {
          return {
            page: {
              type: String,
              reflectToAttribute: true,
              observer: '_pageChanged',
              notify: true
            },

            view: {
              type: String,
              reflectToAttribute: true,
              notify: true
            },

            routeData: Object,
            subroute: String,
            // This shouldn't be neccessary, but the Analyzer isn't picking up
            // Polymer.Element#rootPath
            rootPath: String,

            currentState: {
              type: Object,
              value: {}
            }
          };
        }

        static get actions() {
          return {
            updateRoute(route) {
              return {
                type: C.UPDATE_ROUTE,
                payload: route
              };
            }
          };
        }

        static get observers() {
          return [
            '_routePageChanged(pageData.page)',
            '_routeSlugChanged(slugData.slug, pageData.page)',
            '_routeActionChanged(actionData.action, pageData.page)',
            '_stateChanged(currentState.*, route)',

          ];
        }

        _routeSlugChanged(slug) {
          this.currentState.slug = slug;
        }

        _routeActionChanged(action) {
          this.currentState.action = action;
        }

        _routePageChanged(page) {
          this.currentState.page = page;
          // If no page was found in the route data, page will be an empty string.
          // Default to 'view1' in that case.
          this.page = page || this.fallBackPage;

        }

        _pageChanged(page) {
          let _view = null;
          
          this.routes().some((route) => {

            if (route.name === page) {

              this.callMiddleware(route);

              _view = route.view
                ? route.view
                : route.name
            }
          })

          this.view = _view;

          Polymer.AppLayout.scroll({ top: 0, behavior: 'silent' });
        }

        callMiddleware(route) {
          if (route.guard.length > 0) {
            route.guard.forEach((item) => {

              this[item]()
            })
          }
        }

        _stateChanged(state, route) {
          this.dispatch('updateRoute', state.value)
        }


      }
</script>